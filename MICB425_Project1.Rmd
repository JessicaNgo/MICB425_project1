---
title: "MICB425_Project1"
author: "Alison Fong 33399149"
date: '2018-03-16'
output: 
  html_document:
    toc: true
---

#Abstract

#Introduction

#Methods

#Results

##Data Cleaning
```{r loading packages}
library(tidyverse)
library(phyloseq)
library(magrittr)

```

```{r, echo=FALSE}
knitr::opts_chunk$set(error = TRUE)
```

```{r data cleaning}
#Mothur data
load(file="mothur.RData")
set.seed(4832)
m.norm = rarefy_even_depth(mothur, sample.size=100000)
m.perc = transform_sample_counts(m.norm, function(x) 100 * x/sum(x))

#Qiime2 data
load(file="qiime2.RData")
set.seed(4832)
q.norm = rarefy_even_depth(qiime2, sample.size=100000)
q.perc = transform_sample_counts(q.norm, function(x) 100 * x/sum(x))

```

##How does microbial community structure change with depth and oxygen concentration?

###Alpha-diversity
```{r Question 1a}
#Mothur data
m.alpha = estimate_richness(m.norm, measures = c("Chao1", "Shannon"))
m.meta.alpha = full_join(rownames_to_column(m.alpha), rownames_to_column(data.frame(m.perc@sam_data)), by = "rowname")

#Mother data - Alpha diversity across depth
m.meta.alpha %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Shannon)) +
   geom_smooth(method='auto', aes(x=as.numeric(Depth_m), y=Shannon)) +
  labs(title="Figure 1: Alpha-diversity across depth using mothur data", y="Shannon's diversity index", x="Depth (m)")

#Mothur data - Alpha diversity across oxygen
m.meta.alpha %>%
ggplot() +
  geom_point(aes(x=O2_uM, y=Shannon)) +
  labs(title="Figure 2: Alpha-diversity across oxygen using mothur data", y="Shannon's diversity index", x="Oxygen (uM)")

#Mothur data - Alpha diversity by oxic/anoxic
m.meta.alpha %>%
  mutate(O2_group = ifelse(O2_uM == 0, "anoxic", "oxic")) %>%
ggplot() +
  geom_boxplot(aes(x=O2_group, y=Shannon)) +
  labs(title="Figure 3: Alpha-diversity by oxic/anoxic using mothur data", y="Shannon's diversity index", x="Oxygen")


#Qiime2 data
q.alpha = estimate_richness(q.norm, measures = c("Chao1", "Shannon"))
q.meta.alpha = full_join(rownames_to_column(q.alpha), rownames_to_column(data.frame(q.perc@sam_data)), by = "rowname")

#Qiime 2 data - Alpha diversity across depth
q.meta.alpha %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Shannon)) +
   geom_smooth(method='auto', aes(x=as.numeric(Depth_m), y=Shannon)) +
  labs(title="Figure 4: Alpha-diversity across depth using qiime2 data", y="Shannon's diversity index", x="Depth (m)")

#Qiime2 data - Alpha-diversity across oxygen
q.meta.alpha %>%
ggplot() +
  geom_point(aes(x=O2_uM, y=Shannon)) +
  labs(title="Figure 5: Alpha-diversity across oxygen using qiime2 data", y="Shannon's diversity index", x="Oxygen (uM)")

#Qiime2 data - Alpha-diversity by oxic/anoxic
q.meta.alpha %>%
  mutate(O2_group = ifelse(O2_uM == 0, "anoxic", "oxic")) %>%
ggplot() +
  geom_boxplot(aes(x=O2_group, y=Shannon)) +
  labs(title="Figure 6: Alpha-diversity by oxic/anoxic using qiime2 data", y="Shannon's diversity index", x="Oxygen")

```

###Taxa presence and abundance
```{r Question 1b}
#Mothur data - Domain across samples
m.perc %>%
 
plot_bar(fill="Domain") +
  geom_bar(aes(fill=Domain), stat="identity") +
  labs(title="Figure 7: Domains across samples using mothur data")

#Mothur data - Phyla across samples
m.perc %>%
 
plot_bar() +
  geom_bar(aes(fill=Domain), stat="identity") +
  facet_wrap(~Phylum, scales="free_y")+
  labs(title="Figure 8: Phyla across samples using mothur data")

#Mothur data - Domain boxplots
m.perc %>%
  tax_glom(taxrank = 'Domain') %>%
  psmelt() %>%
ggplot() +
  geom_boxplot(aes(x=Domain, y=Abundance)) +
  coord_flip() +
  labs(title="Figure 9: Domain boxplots using mothur data")

#Qiime2 data - Domain across samples
q.perc %>%
 
plot_bar(fill="Domain") +
  geom_bar(aes(fill=Domain), stat="identity") +
  labs(title="Figure 10: Domains across samples using qiime2 data")

#Qiime2 data - Phyla across samples
q.perc %>%
 
plot_bar() +
  geom_bar(aes(fill=Domain), stat="identity") +
  facet_wrap(~Phylum, scales="free_y")+
  labs(title="Figure 11: Phyla across samples using qiime2 data")

#Qiime2 - Domain boxplots
q.perc %>%
  tax_glom(taxrank = 'Domain') %>%
  psmelt() %>%
ggplot() +
  geom_boxplot(aes(x=Domain, y=Abundance)) +
  coord_flip() +
  labs(title="Figure 12: Domain boxplots using qiime2 data")

```

##Does your taxon of interest significantly differ in abundance with depth and/or oxygen concentration?
###Mothur data
```{r Question 2a}
#Calculating significance with linear model for depth
m.norm %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  tax_glom(taxrank = 'Phylum') %>%
  psmelt() %>%
  
  lm(Abundance ~ Depth_m, .) %>% 
  summary()

#Plot to go along with linear model above
m.perc %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  psmelt() %>% 
  group_by(Sample) %>% 
  summarize(Abundance_sum=sum(Abundance), Depth_m=mean(Depth_m)) %>% 
  
  ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(Depth_m), y=Abundance_sum)) +
  labs(title="Figure 13: Abundance of Cyanobacteria across depth")

#Calculating significance with linear model for oxygen
m.norm %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  tax_glom(taxrank = 'Phylum') %>% 
  psmelt() %>% 
  
  lm(Abundance ~ O2_uM, .) %>% 
  summary()

#Plot to go along with linear model above
m.perc %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  psmelt() %>% 
  group_by(Sample) %>% 
  summarize(Abundance_sum=sum(Abundance), O2_uM=mean(O2_uM)) %>% 
  
  ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(O2_uM), y=Abundance_sum)) +
  labs(title="Figure 14: Abundance of Cyanobacteria across oxygen concentrations")

```

###Qiime2 data

```{r Question 2b}

#Calculating significance with linear model for depth
library(dplyr)
library(ggplot2)
# P-value
q.norm %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  tax_glom(taxrank = 'Phylum') %>%
  psmelt() %>%
  
  lm(Abundance ~ Depth_m, .) %>%
  summary()

#Plot to go along with linear model above
q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
  group_by(Sample) %>%
  summarize(Abundance_sum=sum(Abundance), Depth_m=mean(Depth_m)) %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(Depth_m), y=Abundance_sum)) +
  labs(title="Figure 15: Abundance unclassified domain across depth using qiime2 data")

#Calculating significance with linear model for oxygen
q.norm %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  tax_glom(taxrank = 'Phylum') %>%
  psmelt() %>%
  lm(Abundance ~ O2_uM, .) %>%
  summary()

#Plot to go along with linear model above
q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
  group_by(Sample) %>%
  summarize(Abundance_sum=sum(Abundance), O2_uM=mean(O2_uM)) %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(O2_uM), y=Abundance_sum)) +
  labs(title="Figure 16: Abundance unclassified domain across oxygen using qiime2 data")

```

##Within your taxon, what is the richness (number of OTUs/ASVs)?

Table showing richness of OTUs using Mothur data
```{r Question 3a}

set.seed(4832)
m.norm = rarefy_even_depth(mothur, sample.size=100000)
q.norm = rarefy_even_depth(qiime2, sample.size=100000)
m.norm %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>%
  estimate_richness(measures = c("Observed"))

```

Table showing richness of ASVs using Qiime2 data
```{r Question 3b}

q.norm %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>%
  estimate_richness(measures = c("Observed"))

```
##Do the abundances of OTUs/ASVs within your taxon of interest change significantly with depth and/or oxygen concentration?

###Mothur data
```{r Question 4a}
#Calculating abundances of OTUs across depth
m.perc %>%
  subset_taxa(Phylum=="Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance)) +
  geom_smooth(method='lm', aes(x=Depth_m, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(title="Figure 17: Abundance of OTUs within cyanobacteria phylum across depth")

m.perc %>%
  subset_taxa(Phylum=="Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=OTU, size=Abundance, color=OTU)) +
  scale_size_continuous(range = c(1,6)) +
  labs(title="Figure 18: Abundance of OTUs within cyanobacteria phylum across depth")

#Calculating abundances of OTUs across oxygen
m.perc %>%
  subset_taxa(Phylum=="Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance)) +
  geom_smooth(method='lm', aes(x=O2_uM, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(title="Figure 19: Abundance of OTUs within cyanobacteria phylum across oxygen")

m.perc %>%
  subset_taxa(Phylum=="Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=OTU, size=Abundance, color=OTU)) +
  scale_size_continuous(range = c(1,6)) +
  labs(title="Figure 20: Abundance of OTUs within cyanobacteria phylum across oxygen")

```

###Qiime2 data
```{r Question 4b}

#Calculating abundaces of ASVs across depth
q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance)) +
  geom_smooth(method='lm', aes(x=Depth_m, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(title="Figure 21: Abundance of ASVs within cyanobacteria phylum across depth")

q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=OTU, size=Abundance, color=OTU)) +
  scale_size_continuous(range = c(1,6)) +
  labs(title="Figure 22: Abundance of ASVs within cyanobacteria phylum across depth")

#Calculating abundance of ASVs across oxygen
q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance)) +
  geom_smooth(method='lm', aes(x=O2_uM, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(title="Figure 23: Abundance of ASVs within cyanobacteria phylum across oxygen")

q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=OTU, size=Abundance, color=OTU)) +
  scale_size_continuous(range = c(0,5)) +
  labs(title="Figure 24: Abundance of ASVs within cyanobacteria phylum across oxygen")

```

#Discussion

#References
