---
title: "MICB425_Project1"
author: 'Team 1: Albert Chang (), Alison Fong (33399149), Karen Lau (16524143), Yaqian
  Luo (59751503), Jessica Ngo (31837131), Peter (Kiet) Truong (36645133)'
date: '2018-03-16'
output:
  html_document: null
  '': default
toc: yes
---

#Abstract

#Introduction

#Methods

#Results

##Environment setup and Data Cleaning
```{r loading packages and data}
library("tidyverse")
library("phyloseq")
library("magrittr")
library("knitr")
library("cowplot")

load("./mothur_phyloseq.RData")
load("./qiime2_phyloseq.RData")
```

```{r, echo=FALSE}
knitr::opts_chunk$set(error = TRUE)
```

```{r data cleaning}
#Mothur data
set.seed(4832)
m.norm = rarefy_even_depth(mothur, sample.size=100000)
m.perc = transform_sample_counts(m.norm, function(x) 100 * x/sum(x))

#Qiime2 data
set.seed(4832)
q.norm = rarefy_even_depth(qiime2, sample.size=100000)
q.perc = transform_sample_counts(q.norm, function(x) 100 * x/sum(x))

```

##How does microbial community structure change with depth and oxygen concentration?

###Alpha-diversity
```{r Question 1a_1, fig.width=14, fig.height=10}
#Mothur data
m.alpha = estimate_richness(m.norm, measures = c("Chao1", "Shannon"))
m.meta.alpha = full_join(rownames_to_column(m.alpha), rownames_to_column(data.frame(m.perc@sam_data)), by = "rowname")

#Mother data - Alpha diversity across depth
plot_1=m.meta.alpha %>%
ggplot() +
   geom_point(aes(x=Depth_m, y=Shannon)) +
   geom_smooth(method='auto', aes(x=as.numeric(Depth_m), y=Shannon)) +
   labs(y="Shannon's diversity index", x="Depth (m)")

#Mothur data - ANOVA test on Alpha diversity across depth
summary(aov(Shannon ~ Depth_m, data = m.meta.alpha))
  
#Mothur data - Alpha diversity across oxygen
plot_2=m.meta.alpha %>%
ggplot() +
  geom_point(aes(x=O2_uM, y=Shannon)) +
  labs(y="Shannon's diversity index", x="Oxygen (uM)")

#Mothur data - Alpha diversity by oxic/anoxic
plot_3=m.meta.alpha %>%
  mutate(O2_group = ifelse(O2_uM == 0, "anoxic", "oxic")) %>%
ggplot() +
  geom_boxplot(aes(x=O2_group, y=Shannon)) +
  labs(y="Shannon's diversity index", x="Oxygen")

plot_grid(plot_1, plot_2, plot_3, labels=c("A", "B","c"))+
   labs(caption="Figure 1. Alpha-diversity across depth or oxygen using mothur data. A) Alpha-diversity across depth using mothur data.
        B) Alpha-diversity across oxygen using mothur data. C) Alpha-diversity by oxic/anoxic using mothur data")+
  theme(plot.caption = element_text(size=rel(1.2)))

# Average and standard deviation of mothur by oxic/anoxic
m.oxygen=m.meta.alpha %>%
  mutate(O2_group = ifelse(O2_uM == 0, "anoxic", "oxic")) 

m.anoxic=m.oxygen%>%
  filter(O2_group=="anoxic")
  
ave.m.anoxic=mean(m.anoxic$Shannon)
st.m.anoxic=sd(m.anoxic$Shannon)

m.oxic=m.oxygen%>%
  filter(O2_group=="oxic")

ave.m.oxic=mean(m.oxic$Shannon)
st.m.oxic=sd(m.oxic$Shannon)

ave.m.anoxic
st.m.anoxic
ave.m.oxic
st.m.oxic
```

``` {r Question 1a_2, fig.width=14, fig.height=10}
#Qiime2 data
q.alpha = estimate_richness(q.norm, measures = c("Chao1", "Shannon"))
q.meta.alpha = full_join(rownames_to_column(q.alpha), rownames_to_column(data.frame(q.perc@sam_data)), by = "rowname")

#Qiime 2 data - Alpha diversity across depth
plot_4=q.meta.alpha %>%
 
ggplot() +
   geom_point(aes(x=Depth_m, y=Shannon)) +
   geom_smooth(method='auto', aes(x=as.numeric(Depth_m), y=Shannon)) +
   labs(y="Shannon's diversity index", x="Depth (m)")
 
#Qiime2 data - ANOVA test on Alpha diversity across depth
summary(aov(Shannon ~ Depth_m, data = q.meta.alpha))

#Qiime2 data - Alpha-diversity across oxygen
plot_5=q.meta.alpha %>%
ggplot() +
  geom_point(aes(x=O2_uM, y=Shannon)) +
  labs(y="Shannon's diversity index", x="Oxygen (uM)") 
 
#Qiime2 data - Alpha-diversity by oxic/anoxic
plot_6=q.meta.alpha %>%
  mutate(O2_group = ifelse(O2_uM == 0, "anoxic", "oxic")) %>%
ggplot() +
  geom_boxplot(aes(x=O2_group, y=Shannon)) +
  labs(y="Shannon's diversity index", x="Oxygen")
  
plot_grid(plot_4, plot_5, plot_6, labels=c("A", "B","c"))+
   labs(caption="Figure 2. Alpha-diversity across depth or oxygen using QIIME2 data. A) Alpha-diversity across depth using QIIME2 data. 
        B) Alpha-diversity across oxygen using QIIME2 data. C) Alpha-diversity by oxic/anoxic using QIIME2 data")+
  theme(plot.caption = element_text(size=rel(1.2)))

# Average and standard deviation of quiime2 by oxic/anoxic
q.oxygen=q.meta.alpha %>%
  mutate(O2_group = ifelse(O2_uM == 0, "anoxic", "oxic")) 

q.anoxic=q.oxygen%>%
  filter(O2_group=="anoxic")

ave.q.anoxic=mean(q.anoxic$Shannon)
sd.q.anoxic=sd(q.anoxic$Shannon)

q.oxic=q.oxygen%>%
  filter(O2_group=="oxic")

ave.q.oxic=mean(q.oxic$Shannon)
sd.q.oxic=sd(q.oxic$Shannon)

ave.q.anoxic
sd.q.anoxic
ave.q.oxic
sd.q.oxic

```

###Taxa presence and abundance
```{r Question 1b_1, fig.width=19, fig.height=15}
#Mothur data - Phyla across samples
m.perc %>%
plot_bar() +
  geom_bar(aes(fill=Phylum), stat="identity") +
  facet_wrap(~Phylum, scales="free_y")+
  theme(legend.position="none")+
  labs(caption="Figure 3. Taxa within phylum level across samples using mothur data")+
  theme(plot.caption = element_text(hjust=0.5, size=rel(1.7)))
```

```{r Question 1b_2, fig.width=18, fig.height=13}
#Qiime2 data - Phyla across samples
q.perc %>%
plot_bar() +
  geom_bar(aes(fill=Phylum), stat="identity") +
  facet_wrap(~Phylum, scales="free_y")+
  theme(legend.position="none")+
  labs(caption="Figure 4. Taxa within phylum level across samples using qiime2 data")+
  theme(plot.caption = element_text(hjust=0.5, size=rel(1.7)))
```

##Does your taxon of interest significantly differ in abundance with depth and/or oxygen concentration?  
###Mothur data
```{r Question 2a, fig.width=8, fig.height=4}
#Calculating significance with linear model for depth
m.norm %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  tax_glom(taxrank = 'Phylum') %>%
  psmelt() %>%
  
  lm(Abundance ~ Depth_m, .) %>% 
  summary()

#Plot to go along with linear model above
plot_7=m.perc %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  psmelt() %>% 
  group_by(Sample) %>% 
  summarize(Abundance_sum=sum(Abundance), Depth_m=mean(Depth_m)) %>% 
  
  ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(Depth_m), y=Abundance_sum)) 

#Calculating significance with linear model for oxygen
m.norm %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  tax_glom(taxrank = 'Phylum') %>% 
  psmelt() %>% 
  
  lm(Abundance ~ O2_uM, .) %>% 
  summary()

#Plot to go along with linear model above
plot_8=m.perc %>% 
  subset_taxa(Phylum=="Cyanobacteria") %>% 
  psmelt() %>% 
  group_by(Sample) %>% 
  summarize(Abundance_sum=sum(Abundance), O2_uM=mean(O2_uM)) %>% 
  
  ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(O2_uM), y=Abundance_sum)) 

plot_grid(plot_7, plot_8, labels=c("A", "B"))+
  labs(caption="Figure 5. Abundance of Cyanobacteria across depth/oxygen concentrations using mothur OTUs. 
       A) Abundance of Cyanobacteria across depth. B) Abundance of Cyanobacteria across oxygen concentrations.")+
  theme(plot.caption = element_text(hjust=0.5,size=rel(0.8)))
```

###Qiime2 data
```{r Question 2b, fig.width=8, fig.height=4}

#Calculating significance with linear model for depth
q.norm %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  tax_glom(taxrank = 'Phylum') %>%
  psmelt() %>%
  
  lm(Abundance ~ Depth_m, .) %>%
  summary()

#Plot to go along with linear model above
plot_9=q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
  group_by(Sample) %>%
  summarize(Abundance_sum=sum(Abundance), Depth_m=mean(Depth_m)) %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(Depth_m), y=Abundance_sum)) 

#Calculating significance with linear model for oxygen
q.norm %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  tax_glom(taxrank = 'Phylum') %>%
  psmelt() %>%
  lm(Abundance ~ O2_uM, .) %>%
  summary()

#Plot to go along with linear model above
plot_10=q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
  group_by(Sample) %>%
  summarize(Abundance_sum=sum(Abundance), O2_uM=mean(O2_uM)) %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance_sum)) +
  geom_smooth(method='lm', aes(x=as.numeric(O2_uM), y=Abundance_sum)) 

plot_grid(plot_9, plot_10, labels=c("A", "B"))+
  labs(caption="Figure 6. Abundance of Cyanobacteria across depth/oxygen concentrations using QIIME2 ASVs. 
       A) Abundance of Cyanobacteria across depth. B) Abundance of Cyanobacteria across oxygen concentrations.")+
  theme(plot.caption = element_text(hjust=0.5,size=rel(0.8)))
```

##Within your taxon, what is the richness (number of OTUs/ASVs)?

Table showing richness of OTUs using Mothur data and ASVs using Qiime2 data
```{r Question 3a}
m.norm %>% 
  subset_taxa(Phylum=="Cyanobacteria")

mothur_otu=m.norm %>% subset_taxa(Phylum=="Cyanobacteria") %>% estimate_richness(measures = c("Observed"))

q.norm %>% 
  subset_taxa(Phylum=="D_1__Cyanobacteria")

qiime_asv=q.norm %>% subset_taxa(Phylum=="D_1__Cyanobacteria") %>%estimate_richness(measures = c("Observed"))

sam_data=data.frame(m.norm@sam_data)

Depth=sam_data%>%select("Depth_m")

otu_asv=cbind(Depth, mothur_otu, qiime_asv)
colnames(otu_asv)=c("Depth_m","OTU","ASV")
kable(otu_asv, caption="Table 1. OTUs/ASVs across depth",align = "c")%>%

```

##Do the abundances of OTUs/ASVs within your taxon of interest change significantly with depth and/or oxygen concentration?

###Mothur data
```{r Question 4a,fig.width=10,fig.height=7}
#filtered table 
m.Cyano=m.norm %>% subset_taxa(Phylum=="Cyanobacteria") 
m.filtered=data.frame(m.Cyano@tax_table)

#General linear model for each OTU across depth
otu_stats = data.frame("Estimate" = numeric(0), "Std. Error"= numeric(0),"t value"= numeric(0),"P_value"= numeric(0))
for (otu in row.names(m.filtered)){
  require(tidyverse)
  require(knitr)
    linear_fit = m.norm %>% 
    psmelt() %>% 
    filter(OTU==otu) %>% 
    lm(Abundance ~ Depth_m, .) %>% 
    summary()
  otu_data = linear_fit$coefficients["Depth_m",]
  otu_stats <- rbind(otu_stats, otu_data)
}

colnames(otu_stats)<- (c("Estimate", "Std. Error","t value","P_value"))
otu_depth=otu_stats%>%
  mutate(Adjusted_P=p.adjust(P_value, method="fdr"))
row.names(otu_depth) <- row.names(m.filtered)
otu_depth_filter=otu_depth[which(otu_depth[,"Adjusted_P"]<=0.05),]
kable(otu_depth_filter,caption="Table 2. Correlation data of Cyanobacteria OTUs with significant differences across depth",align = "c")

#Calculating abundances of OTUs across depth
m.perc %>%
  subset_taxa(Phylum=="Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance)) +
  geom_smooth(method='lm', aes(x=Depth_m, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(caption="Figure 7. Abundance of OTUs within Phylum Cyanobacteria across depth")+
  theme(plot.caption = element_text(hjust=0.5, size=rel(0.9)))

#General linear model for each OTU across oxygen
otu_stats_O2 = data.frame("Estimate" = numeric(0), "Std. Error"= numeric(0),"t value"= numeric(0),"P_value"= numeric(0))
for (otu in row.names(m.filtered)){
  require(tidyverse)
  require(knitr)
    linear_fit = m.norm %>% 
    psmelt() %>% 
    filter(OTU==otu) %>% 
    lm(Abundance ~ O2_uM, .) %>% 
    summary()
  otu_data_O2 = linear_fit$coefficients["O2_uM",]
  otu_stats_O2 <- rbind(otu_stats_O2, otu_data_O2)
}

colnames(otu_stats_O2)<- (c("Estimate", "Std. Error","t value","P_value"))
otu_oxygen=otu_stats_O2%>%
  mutate(Adjusted_P=p.adjust(P_value, method="fdr"))
row.names(otu_oxygen) <- row.names(m.filtered)
otu_oxygen_filter=otu_oxygen[which(otu_oxygen[,"Adjusted_P"]<=0.05),]
kable(otu_oxygen_filter,caption="Table 3. Correlation data of Cyanobacteria OTUs with significant differences across oxygen", align = "c")

#Calculating abundances of OTUs across oxygen
m.perc %>%
  subset_taxa(Phylum=="Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance)) +
  geom_smooth(method='lm', aes(x=O2_uM, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(caption="Figure 8. Abundance of OTUs within Cyanobacteria across oxygen")+
  theme(plot.caption = element_text(hjust=0.5, size=rel(0.9)))

```

###Qiime2 data
```{r Question 4b_1}
#filtered table 
q.Cyano=q.norm %>% subset_taxa(Phylum=="D_1__Cyanobacteria") 
q.filtered=data.frame(q.Cyano@tax_table)

#General linear model for each ASV across depth
asv_stats = data.frame("Estimate" = numeric(0), "Std. Error"= numeric(0),"t value"= numeric(0),"P_value"= numeric(0))
for (asv in row.names(q.filtered)){
  require(tidyverse)
  require(knitr)
    linear_fit = q.norm %>% 
    psmelt() %>% 
    filter(OTU==asv) %>% 
    lm(Abundance ~ Depth_m, .) %>% 
    summary()
  asv_data = linear_fit$coefficients["Depth_m",]
  asv_stats <- rbind(asv_stats, asv_data)
}

colnames(asv_stats)<- (c("Estimate", "Std. Error","t value","P_value"))
asv_depth=asv_stats%>%
  mutate(Adjusted_P=p.adjust(P_value, method="fdr"))
row.names(asv_depth) <- row.names(q.filtered)
asv_depth_filter=asv_depth[which(asv_depth[,"Adjusted_P"]<=0.05),]
kable(asv_depth_filter,caption="Correlation data of Cyanobacteria ASVs with significant differences across depth",align = "c")
```

```{r Question 4b_2, fig.width=15, fig.height=10}
#Calculating abundaces of ASVs across depth
q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=Depth_m, y=Abundance)) +
  geom_smooth(method='lm', aes(x=Depth_m, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(caption="Figure 9. Abundance of ASVs within cyanobacteria across depth")+
  theme(plot.caption = element_text(hjust=0.5, size=rel(1.3)))
```

```{r Question 4b_3}
#General linear model for each ASV across oxygen
asv_stats_O2 = data.frame("Estimate" = numeric(0), "Std. Error"= numeric(0),"t value"= numeric(0),"P_value"= numeric(0))
for (asv in row.names(q.filtered)){
  require(tidyverse)
  require(knitr)
    linear_fit = q.norm %>% 
    psmelt() %>% 
    filter(OTU==asv) %>% 
    lm(Abundance ~ O2_uM, .) %>% 
    summary()
  asv_data_O2 = linear_fit$coefficients["O2_uM",]
  asv_stats_O2 <- rbind(asv_stats_O2, asv_data_O2)
}

colnames(asv_stats_O2)<- (c("Estimate", "Std. Error","t value","P_value"))
asv_oxygen=asv_stats_O2%>%
  mutate(Adjusted_P=p.adjust(P_value, method="fdr"))
row.names(asv_oxygen) <- row.names(q.filtered)
asv_oxygen_filter=asv_oxygen[which(asv_oxygen[,"Adjusted_P"]<=0.05),]
kable(asv_oxygen_filter,caption="Table 4. Correlation data of Cyanobacteria ASVs with significant differences across oxygen", align = "c")
```

```{r Question 4b_4, fig.width=13, fig.height=8}
#Calculating abundance of ASVs across oxygen
q.perc %>%
  subset_taxa(Phylum=="D_1__Cyanobacteria") %>%
  psmelt() %>%
 
ggplot() +
  geom_point(aes(x=O2_uM, y=Abundance)) +
  geom_smooth(method='lm', aes(x=O2_uM, y=Abundance)) +
  facet_wrap(~OTU, scales="free_y") +
  labs(caption="Figure 10. Abundance of ASVs within Cyanobacteria across oxygen")+
  theme(plot.caption = element_text(hjust=0.5, size=rel(1.2)))
```

#Discussion
```{r, fig.width=10, fig.height=7}
# Geochemical parameters across depth
sam_data=data.frame(m.norm@sam_data)
sam_data1=sam_data%>%mutate(CH4_uM=CH4_nM/1000)
nutrient=sam_data1 %>% select(Depth_m,O2_uM,PO4_uM,SiO2_uM,NO3_uM,NH4_uM,NO2_uM,H2S_uM,N2O_nM,CH4_uM,Temperature_C, Fluorescence_mgm_3) %>% gather(nutrient,uM,O2_uM,PO4_uM,SiO2_uM,NO3_uM,NH4_uM,NO2_uM,H2S_uM,N2O_nM,CH4_uM, Temperature_C, Fluorescence_mgm_3)
library(ggplot2)
ggplot(nutrient,aes(x=Depth_m,y=uM))+
  geom_line()+
  geom_point()+
  ylab("Concentration or degree or mgm3")+
  facet_wrap(~nutrient,scales="free_y")+
  labs(caption="Figure 11. Geochemical parameters across depth")+
  theme(plot.caption = element_text(hjust=0.5, size=rel(0.8)))
```

```{r}
# Linear model of fluorescence across depth
sam_data%>%
  lm(Fluorescence_mgm_3~Depth_m,.)%>%
  summary()
```

#References
